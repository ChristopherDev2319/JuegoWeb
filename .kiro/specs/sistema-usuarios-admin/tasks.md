# Implementation Plan

- [x] 1. Set up PostgreSQL and environment configuration
  - [x] 1.1 Create environment configuration files
    - Create `backend/.env.development` with local PostgreSQL settings
    - Create `backend/.env.production` with VPS PostgreSQL settings
    - Create `backend/config/env.js` to load config based on NODE_ENV
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  - [ ]* 1.2 Write property test for environment config loading
    - **Property 20: Environment-specific config loading**
    - **Validates: Requirements 7.1, 7.2, 7.3, 7.4**
  - [ ]* 1.3 Write property test for missing env variable
    - **Property 21: Missing required env variable fails startup**
    - **Validates: Requirements 7.5**
  - [x] 1.4 Update database.js for PostgreSQL
    - Replace mysql2 with pg library
    - Implement connection pool with retry logic
    - Add testConnection function
    - _Requirements: 8.1, 8.2, 8.4_
  - [ ]* 1.5 Write property test for connection retry
    - **Property 22: Database connection retry with backoff**
    - **Validates: Requirements 8.4**

- [x] 2. Set up migration system
  - [x] 2.1 Create migrations directory structure and runner
    - Create `backend/migrations/` directory
    - Create `backend/migrations/sql/` for SQL files
    - Implement `MigrationRunner` class with `runPending()` and `executeMigration()` methods
    - Add migration tracking table creation as bootstrap
    - _Requirements: 5.1, 5.2, 5.3_
  - [ ]* 2.2 Write property test for migration idempotence
    - **Property 15: Migration idempotence**
    - **Validates: Requirements 5.5**
  - [ ]* 2.3 Write property test for migration rollback
    - **Property 16: Migration rollback on failure**
    - **Validates: Requirements 5.3**

- [x] 3. Create database migrations for schema
  - [x] 3.1 Create migration to update users table
    - Add `role` column with CHECK constraint ('player', 'admin')
    - Add index on role column
    - Update existing users to have 'player' role
    - _Requirements: 1.1, 4.1_
  - [x] 3.2 Create migration for player_stats table
    - Create table with user_id (PK + FK), kills, deaths, matches
    - Add timestamps with TIMESTAMPTZ
    - Add trigger for updated_at
    - _Requirements: 2.1, 2.2, 2.3_
  - [x] 3.3 Create migration for bans table
    - Create table with id (SERIAL), user_id, reason, expires_at, created_by, created_at
    - Add foreign keys and indexes
    - _Requirements: 3.1, 3.2_

- [x] 4. Checkpoint - Ensure migrations work
  - Ensure all tests pass, ask the user if questions arise.

- [x] 5. Update authentication system
  - [x] 5.1 Modify registration to create player_stats and include role
    - Update register endpoint to insert player_stats record
    - Include role in JWT token payload
    - Use PostgreSQL syntax ($1, $2 placeholders)
    - _Requirements: 1.1_
  - [ ]* 5.2 Write property test for registration
    - **Property 1: Registration creates user with correct role and stats**
    - **Validates: Requirements 1.1**
  - [ ]* 5.3 Write property test for uniqueness
    - **Property 2: Username and email uniqueness**
    - **Validates: Requirements 1.2**
  - [x] 5.4 Add ban check to login flow
    - Query active bans before allowing login
    - Return ban info if user is banned
    - _Requirements: 3.3, 3.4_
  - [ ]* 5.5 Write property test for banned user login
    - **Property 9: Banned user login rejection**
    - **Validates: Requirements 3.3**
  - [ ]* 5.6 Write property test for expired ban login
    - **Property 10: Expired ban allows login**
    - **Validates: Requirements 3.4**

- [x] 6. Checkpoint - Ensure auth tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 7. Implement stats API
  - [x] 7.1 Create stats routes and controller
    - `GET /api/stats/me` - Get current user stats
    - `PUT /api/stats/update` - Update stats (kills, deaths, matches)
    - `GET /api/stats/leaderboard` - Top players by kills
    - _Requirements: 2.1, 2.2, 2.3, 2.4_
  - [ ]* 7.2 Write property test for stats increment
    - **Property 5: Stats increment correctly**
    - **Validates: Requirements 2.1, 2.2, 2.3**
  - [ ]* 7.3 Write property test for stats retrieval
    - **Property 6: Stats retrieval returns all fields**
    - **Validates: Requirements 2.4**
  - [ ]* 7.4 Write property test for stats persistence
    - **Property 7: Stats persistence**
    - **Validates: Requirements 2.5**

- [x] 8. Implement admin middleware and ban management
  - [x] 8.1 Create admin middleware
    - Implement `requireAdmin` middleware to check user role
    - Return 403 if user is not admin
    - _Requirements: 4.1, 4.5_
  - [ ]* 8.2 Write property test for admin authorization
    - **Property 12: Admin role authorization**
    - **Validates: Requirements 4.1, 4.5**
  - [x] 8.3 Create ban routes and controller
    - `POST /api/admin/bans` - Create ban (temp or permanent)
    - `DELETE /api/admin/bans/:id` - Remove ban
    - `GET /api/admin/bans` - List active bans
    - _Requirements: 3.1, 3.2, 3.5_
  - [ ]* 8.4 Write property test for ban creation
    - **Property 8: Ban creation and storage**
    - **Validates: Requirements 3.1, 3.2**
  - [ ]* 8.5 Write property test for ban removal round-trip
    - **Property 11: Ban removal restores access (round-trip)**
    - **Validates: Requirements 3.5**

- [x] 9. Implement admin user management
  - [x] 9.1 Create admin user routes
    - `GET /api/admin/users` - List users with pagination and search
    - `GET /api/admin/users/:id` - User detail with stats and ban history
    - _Requirements: 4.2, 4.3, 4.4_
  - [ ]* 9.2 Write property test for user list fields
    - **Property 13: User list contains required fields**
    - **Validates: Requirements 4.2**
  - [ ]* 9.3 Write property test for user search
    - **Property 14: User search filters correctly**
    - **Validates: Requirements 4.4**

- [x] 10. Checkpoint - Ensure admin API tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 11. Implement API validation and error handling
  - [x] 11.1 Create validation middleware for all endpoints
    - Validate required fields, types, and formats
    - Return 400 with specific field errors
    - _Requirements: 6.3_
  - [ ]* 11.2 Write property test for invalid input handling
    - **Property 19: Invalid input returns 400**
    - **Validates: Requirements 6.3**
  - [x] 11.3 Standardize API response format
    - Ensure all responses have success, data/message structure
    - Sanitize error messages in production
    - _Requirements: 6.1, 6.5_
  - [ ]* 11.4 Write property test for response format
    - **Property 17: API response format consistency**
    - **Validates: Requirements 6.1**
  - [ ]* 11.5 Write property test for authentication requirement
    - **Property 18: Protected endpoints require authentication**
    - **Validates: Requirements 6.4**


- [x] 12. Create admin panel frontend
  - [x] 12.1 Create admin panel HTML page
    - Create `admin.html` with navigation and layout
    - Add login check and redirect for non-admins
    - _Requirements: 4.1_
  - [x] 12.2 Implement users list view
    - Display users table with pagination
    - Add search functionality
    - _Requirements: 4.2, 4.4_
  - [x] 12.3 Implement user detail view
    - Show user info, stats, and ban history
    - _Requirements: 4.3_
  - [x] 12.4 Implement ban management UI
    - Form to create new ban (reason, expiration)
    - Button to remove existing bans
    - _Requirements: 3.1, 3.2, 3.5_

- [x] 13. Integrate with game server
  - [x] 13.1 Update game server to send stats updates
    - Send kill/death events to stats API
    - Send match completion events
    - _Requirements: 2.1, 2.2, 2.3_
  - [x] 13.2 Add ban check on game connection
    - Verify user is not banned when joining game
    - _Requirements: 3.3_

- [x] 14. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
