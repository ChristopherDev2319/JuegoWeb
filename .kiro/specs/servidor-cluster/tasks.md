# Implementation Plan

- [x] 1. Configuración base del cluster
  - [x] 1.1 Crear archivo de configuración del cluster
    - Crear `server/cluster/config.js` con constantes configurables
    - Incluir límites de workers, salas, jugadores y timeouts
    - Soportar variables de entorno para override
    - _Requirements: 6.3_
  - [ ]* 1.2 Write property test para configuración
    - **Property 5: Formato JSON de mensajes IPC**
    - **Validates: Requirements 3.4**

- [x] 2. Implementar ClusterManager (Master)
  - [x] 2.1 Crear estructura base del ClusterManager
    - Crear `server/cluster/clusterManager.js`
    - Implementar inicialización de workers
    - Manejar eventos de exit de workers
    - _Requirements: 1.1, 1.2_
  - [ ]* 2.2 Write property test para inicialización
    - **Property 1: Inicialización correcta del cluster**
    - **Validates: Requirements 1.1**
  - [ ]* 2.3 Write property test para reinicio de workers
    - **Property 2: Reinicio de workers fallidos**
    - **Validates: Requirements 1.2**
  - [x] 2.4 Implementar shutdown graceful
    - Manejar SIGINT y SIGTERM
    - Enviar señal de cierre a todos los workers
    - Esperar completación o timeout
    - _Requirements: 1.3, 1.4_

- [x] 3. Implementar LoadBalancer
  - [x] 3.1 Crear módulo de balanceo de carga
    - Crear `server/cluster/loadBalancer.js`
    - Implementar función de hash para sticky sessions
    - Implementar selección de worker con menos carga
    - _Requirements: 2.1, 4.1, 4.4_
  - [ ]* 3.2 Write property test para sticky sessions
    - **Property 6: Sticky sessions consistentes**
    - **Validates: Requirements 4.1, 4.4**
  - [ ]* 3.3 Write property test para balanceo de carga
    - **Property 3: Balanceo de carga por salas**
    - **Validates: Requirements 2.1, 2.2**
  - [x] 3.4 Implementar límites de recursos
    - Verificar límite de 15 salas por worker
    - Verificar límite de 120 jugadores por worker
    - Marcar workers como no disponibles cuando exceden límites
    - _Requirements: 2.2, 6.1, 6.2_
  - [ ]* 3.5 Write property test para límite de jugadores
    - **Property 7: Límite de jugadores por worker**
    - **Validates: Requirements 6.2**

- [x] 4. Implementar comunicación IPC
  - [x] 4.1 Crear módulo IPCHandler
    - Crear `server/cluster/ipcHandler.js`
    - Implementar envío de mensajes al master
    - Implementar envío de mensajes a workers específicos
    - Serializar mensajes en formato JSON
    - _Requirements: 3.1, 3.2, 3.4_
  - [x] 4.2 Implementar reporte de métricas
    - Workers envían métricas cada 30 segundos
    - Incluir conteo de salas, jugadores y uso de memoria
    - _Requirements: 5.1, 2.3_
  - [ ]* 4.3 Write property test para consistencia de métricas
    - **Property 4: Consistencia de métricas**
    - **Validates: Requirements 2.3, 5.4**

- [x] 5. Checkpoint - Verificar tests de propiedades
  - Ensure all tests pass, ask the user if questions arise.

- [x] 6. Implementar WorkerServer
  - [x] 6.1 Crear módulo WorkerServer
    - Crear `server/cluster/workerServer.js`
    - Adaptar código de `server/index.js` para correr como worker
    - Mantener RoomManager y conexiones independientes por worker
    - _Requirements: 3.1_
  - [x] 6.2 Implementar reporte de métricas desde worker
    - Enviar estado al master periódicamente
    - Reportar salas activas y jugadores conectados
    - _Requirements: 3.1, 5.1_
  - [x] 6.3 Implementar limpieza de salas vacías
    - Limpiar salas inactivas después de 60 segundos
    - Notificar al master cuando se eliminan salas
    - _Requirements: 2.4_

- [x] 7. Integrar cluster con entry point
  - [x] 7.1 Modificar server/index.js para soportar cluster
    - Detectar si es master o worker
    - Master: inicializar ClusterManager
    - Worker: inicializar WorkerServer
    - _Requirements: 1.1_
  - [x] 7.2 Implementar logging del cluster
    - Registrar métricas cada 30 segundos
    - Registrar advertencias de memoria alta
    - Registrar reinicios de workers
    - _Requirements: 5.1, 5.2, 5.3_

- [x] 8. Implementar matchmaking distribuido
  - [x] 8.1 Adaptar matchmaking para cluster
    - Master consulta disponibilidad en todos los workers
    - Seleccionar sala óptima considerando todos los workers
    - _Requirements: 3.3_
  - [x] 8.2 Implementar endpoint de estado del cluster
    - Retornar JSON con workers activos, salas y jugadores
    - Exponer métricas para monitoreo externo
    - _Requirements: 5.4_

- [x] 9. Checkpoint final
  - Ensure all tests pass, ask the user if questions arise.

- [ ]* 10. Tests de integración opcionales
  - [ ]* 10.1 Test de ciclo de vida del cluster
    - Verificar inicio, operación y cierre del cluster
  - [ ]* 10.2 Test de reconexión de clientes
    - Verificar comportamiento cuando un worker falla
    - _Requirements: 4.2, 4.3_
