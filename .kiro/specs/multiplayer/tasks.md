# Implementation Plan

- [x] 1. Set up project structure and dependencies
  - [x] 1.1 Create package.json with server dependencies (ws, express)
    - Initialize npm project
    - Add ws (WebSocket library) and express dependencies
    - Add fast-check for property-based testing
    - Add npm scripts for starting server
    - _Requirements: 8.4_
  - [x] 1.2 Create server directory structure
    - Create `/server` directory for server code
    - Create `/src/network` directory for client network modules
    - _Requirements: 8.1, 8.2_

- [x] 2. Implement server core
  - [x] 2.1 Create server configuration module (`server/config.js`)
    - Define player config (200 HP, speed, gravity, spawn points)
    - Define weapon config (20 damage, 30 magazine, 2s reload)
    - Define dash config (3 charges, 3s recharge)
    - _Requirements: 5.3, 5.5, 6.4, 7.4_
  - [x] 2.2 Create player state module (`server/playerState.js`)
    - Implement PlayerState class with all properties
    - Implement createPlayer function with default values
    - Implement updatePosition, applyDamage, reload, dash methods
    - _Requirements: 1.2, 5.3, 5.4, 5.5, 6.2, 6.4, 7.2, 7.3_
  - [ ]* 2.3 Write property test for player state
    - **Property 7: Damage Application**
    - **Property 8: Death State Transition**
    - **Property 9: Respawn Health Restoration**
    - **Validates: Requirements 5.3, 5.4, 5.5**
  - [x] 2.4 Create bullet system module (`server/bulletSystem.js`)
    - Implement Bullet class with position, direction, owner
    - Implement collision detection with players
    - Implement bullet update and cleanup
    - _Requirements: 5.2, 5.3_
  - [ ]* 2.5 Write property test for bullet collision
    - **Property 6: Bullet Creation on Shoot**
    - **Validates: Requirements 5.1, 5.2**

- [x] 3. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Implement game manager and serialization
  - [x] 4.1 Create game state serialization module (`server/serialization.js`)
    - Implement serializeGameState function (to JSON)
    - Implement deserializeGameState function (from JSON)
    - Implement serializeMessage and deserializeMessage helpers
    - _Requirements: 1.5, 9.1, 9.2, 9.3_
  - [ ]* 4.2 Write property test for serialization round-trip
    - **Property 3: Game State Serialization Round-Trip**
    - **Validates: Requirements 1.5, 9.1, 9.2, 9.3**
  - [x] 4.3 Create game manager module (`server/gameManager.js`)
    - Implement GameManager class with players Map and bullets array
    - Implement addPlayer, removePlayer methods
    - Implement processInput method for all input types
    - Implement update method with game loop logic
    - Implement getState method
    - _Requirements: 1.2, 1.3, 4.2, 5.2, 6.2, 7.2_
  - [ ]* 4.4 Write property tests for game manager
    - **Property 1: Unique Player ID Assignment**
    - **Property 2: Player Removal on Disconnect**
    - **Validates: Requirements 1.2, 1.3, 2.2**

- [x] 5. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 6. Implement WebSocket server
  - [x] 6.1 Create WebSocket server (`server/index.js`)
    - Set up Express for static file serving
    - Set up WebSocket server on configurable port
    - Handle connection events (assign ID, send welcome)
    - Handle disconnection events (remove player, broadcast)
    - Handle incoming messages (route to game manager)
    - Start game loop at 60Hz tick rate
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 8.3_
  - [ ]* 6.2 Write property test for malformed data handling
    - **Property 15: Malformed Data Handling**
    - **Validates: Requirements 9.5**

- [x] 7. Implement client network layer
  - [x] 7.1 Create network connection module (`src/network/connection.js`)
    - Implement connect function with WebSocket
    - Implement disconnect function
    - Implement message sending and receiving
    - Implement event callbacks (onGameState, onPlayerJoined, onPlayerLeft)
    - _Requirements: 2.1, 2.2, 2.3_
  - [x] 7.2 Create input sender module (`src/network/inputSender.js`)
    - Implement sendMovement function
    - Implement sendShoot function
    - Implement sendReload function
    - Implement sendDash function
    - _Requirements: 3.3, 4.1, 5.1, 6.1, 7.1_
  - [ ]* 7.3 Write property test for input sending
    - **Property 4: Movement Input Processing**
    - **Validates: Requirements 3.2, 3.3, 4.1, 4.2, 4.3**

- [x] 8. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 9. Implement remote player rendering
  - [x] 9.1 Create remote player class (`src/entidades/JugadorRemoto.js`)
    - Implement RemotePlayer class extending cube mesh
    - Add weapon model to remote player
    - Add health bar sprite above player
    - Implement updateFromState method
    - Implement interpolation for smooth movement
    - _Requirements: 3.1, 3.2, 3.4_
  - [x] 9.2 Create remote player manager (`src/network/remotePlayers.js`)
    - Implement addPlayer, removePlayer methods
    - Implement updatePlayers method from game state
    - Implement interpolate method for smooth rendering
    - _Requirements: 3.2, 2.5_

- [x] 10. Implement weapon and dash server logic
  - [x] 10.1 Add reload logic to game manager
    - Process reload input
    - Track reload timer per player
    - Block shooting during reload
    - Restore ammo on completion
    - _Requirements: 6.2, 6.3, 6.4, 6.5_
  - [ ]* 10.2 Write property tests for reload system
    - **Property 10: Reload Prevents Firing**
    - **Property 11: Reload Restores Ammunition**
    - **Validates: Requirements 6.2, 6.3, 6.4**
  - [x] 10.3 Add dash logic to game manager
    - Process dash input
    - Validate dash charges
    - Apply dash movement
    - Regenerate charges over time
    - _Requirements: 7.2, 7.3, 7.4, 7.5_
  - [ ]* 10.4 Write property tests for dash system
    - **Property 12: Dash Charge Validation**
    - **Property 13: Dash Position Change**
    - **Property 14: Dash Charge Consumption**
    - **Validates: Requirements 7.2, 7.3**

- [x] 11. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 12. Implement gravity and respawn
  - [x] 12.1 Add gravity processing to game manager
    - Apply gravity to all players each tick
    - Handle ground collision
    - Process jump inputs
    - _Requirements: 4.5_
  - [ ]* 12.2 Write property test for gravity
    - **Property 5: Gravity and Ground Collision**
    - **Validates: Requirements 4.5**
  - [x] 12.3 Add respawn system to game manager
    - Track death time per player
    - Respawn after 5 seconds
    - Restore full health (200)
    - Place at random spawn point
    - _Requirements: 5.5_

- [x] 13. Integrate client with multiplayer
  - [x] 13.1 Modify main.js for multiplayer
    - Initialize network connection on load
    - Create local player on welcome message
    - Update local player from server state
    - Send inputs to server instead of local processing
    - _Requirements: 2.1, 2.2, 3.3, 4.1_
  - [x] 13.2 Modify player module for network sync
    - Add method to apply server state
    - Keep local prediction for responsiveness
    - Reconcile with server state
    - _Requirements: 3.2, 4.2_
  - [x] 13.3 Modify weapon system for network
    - Send shoot input to server
    - Update ammo from server state
    - Show reload state from server
    - _Requirements: 5.1, 6.1, 6.5_
  - [x] 13.4 Modify dash system for network
    - Send dash input to server
    - Update charges from server state
    - _Requirements: 7.1, 7.5_

- [x] 14. Add death and respawn UI
  - [x] 14.1 Implement death handling on client
    - Show death animation for local player
    - Display respawn countdown
    - Handle respawn event
    - _Requirements: 3.5, 5.4, 5.5_
  - [x] 14.2 Implement kill feed UI
    - Show who killed whom
    - Display damage indicators
    - _Requirements: 5.3, 5.4_

- [x] 15. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

